---
import GitHub from "./icons/GitHub.astro";
import Link from "./icons/Link.astro";
import LinkButton from "./LinkButton.astro";

const { projects, i18n } = Astro.props
---

<div class="embla relative" id="projects-carousel">
  <div class="embla__container">
    {projects.map(({ title, description, github, link, topics, languages, image, disclaimer, role, company, period }) => (
      <div class="embla__slide">
        <article class="flex flex-col gap-6 pb-4"> 
          
          {/* Top Section: Image + Header Info */}
          <div class="flex flex-col md:flex-row gap-6 md:items-start">
            
            {/* Image (Smaller width now) */}
            <div class="w-full md:w-[45%] shrink-0">
              <div class="relative flex flex-col items-center col-span-6 row-span-5 gap-8 transition duration-500 ease-in-out transform shadow-xl overflow-clip rounded-xl sm:rounded-xl lg:border lg:border-gray-800 lg:hover:border-gray-700 lg:hover:bg-gray-800/50">
                <img 
                  alt={title} 
                  class="object-cover object-top w-full h-48 sm:h-full md:scale-110 md:group-hover:scale-105" 
                  loading="lazy" 
                  src={image} 
                />
              </div>
            </div>

            {/* Header Info (Title, Tags, Meta) */}
            <div class="w-full md:w-[55%]">
              <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">{title}</h3>

              {/* Company / Role */}
              {company && <div class="text-sm text-gray-500 mt-1">{company} {period ? `â€¢ ${period}` : ""}</div>}
              {role && <div class="text-sm text-gray-500">{role}</div>}

              {/* Disclaimer */}
              {disclaimer && <div class="mt-1 text-sm text-yellow-600 dark:text-yellow-500 text-pretty">{disclaimer}</div>}

              {/* Topics */}
              <ul class="flex flex-row mt-3 gap-x-2 flex-wrap mb-2">
                {topics.map(tag => (
                  <li class="mb-2">
                    <span class="flex gap-x-2 rounded-full text-xs bg-gray-700 text-white py-1 px-2">
                      {tag}
                    </span>
                  </li>
                ))}
              </ul>
              
              {/* Languages */}
              {languages && languages.length > 0 && (
                <div class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                  {languages.map(lang => (
                    <span class="mr-3">
                      <strong>{lang.name}</strong> {lang.percent}
                    </span>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Bottom Section: Description + Links */}
          <div class="w-full">
            <div class="text-gray-700 dark:text-gray-400 text-pretty">{description}</div>

            {/* Links */}
            <footer class="flex items-end justify-start mt-4 gap-x-4">
              {github && (
                <LinkButton href={github}>
                  <GitHub class="size-6" />
                  {i18n?.PROJECTS?.CODE || "Code"}
                </LinkButton>
              )}
              {link && (
                <LinkButton href={link}>
                  <Link class="size-4" />
                  {i18n?.PROJECTS?.PREVIEW || "Preview"}
                </LinkButton>
              )}
            </footer>
          </div>

        </article>
      </div>
    ))}
  </div>

  {/* Navigation Buttons */}
  {/* Navigation Buttons (Moved below to avoid overlap) */}
  <div class="flex justify-end gap-2 mt-4 px-4">
    <button class="embla__prev bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 p-2 rounded-full transition-colors border border-gray-200 dark:border-gray-700 shadow-sm" aria-label="Anterior">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 6l-6 6l6 6" /></svg>
    </button>
    <button class="embla__next bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200 p-2 rounded-full transition-colors border border-gray-200 dark:border-gray-700 shadow-sm" aria-label="Siguiente">
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-right" width="20" height="20" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 6l6 6l-6 6" /></svg>
    </button>
  </div>
</div>

<style>
  .embla {
    overflow: hidden;
  }
  .embla__container {
    display: flex;
    gap: 2rem; /* Espaciado entre slides */
  }
  .embla__slide {
    flex: 0 0 100%;
    min-width: 0;
  }
</style>

<script>
  import EmblaCarousel from 'embla-carousel'
  import Autoplay from 'embla-carousel-autoplay'

  const initCarousel = () => {
    const emblaNode = document.querySelector('#projects-carousel') as HTMLElement
    const prevBtn = emblaNode?.querySelector('.embla__prev') as HTMLButtonElement
    const nextBtn = emblaNode?.querySelector('.embla__next') as HTMLButtonElement

    if (emblaNode) {
      const emblaApi = EmblaCarousel(emblaNode, { loop: true }, [
        Autoplay({ delay: 8000, stopOnInteraction: true })
      ])

      // Clean up previous listeners if any (though usually simpler to just add new ones on refresh)
      // A more robust way is to clone node or track listeners. 
      // For Astro Page Load, simple addEventListener is fine since DOM is fresh.
      
      if (prevBtn) prevBtn.onclick = () => emblaApi.scrollPrev()
      if (nextBtn) nextBtn.onclick = () => emblaApi.scrollNext()
    }
  }

  document.addEventListener('astro:page-load', initCarousel)
</script>
