---
import SunIcon from "./icons/Sun.astro"
import MoonIcon from "./icons/Moon.astro"
---

<div class="relative ml-1 mr-1">
  <button
    id="theme-toggle-btn"
    class="appearance-none border-none flex hover:scale-125 transition"
  >
    <span class="sr-only">Elige el tema</span>
    <SunIcon id="light" class="theme-toggle-icon size-5 transition-all" />
    <MoonIcon
      id="dark"
      class="theme-toggle-icon absolute size-5 transition-all"
    />
  </button>
</div>

<script is:inline>
  const handleToggleClick = () => {
    const element = document.documentElement
    element.classList.toggle("dark")

    const isDark = element.classList.contains("dark")
    localStorage.setItem("theme", isDark ? "dark" : "light")
    
    updateThemeUI(isDark)
  }

  const updateThemeUI = (isDark) => {
    const lightIcon = document.getElementById("light")
    const darkIcon = document.getElementById("dark")

    if (lightIcon && darkIcon) {
        // Show Sun (light) when it's dark setting (to switch to light)
        // OR Show Moon (dark) when it's light setting (to switch to dark)
        // Usually: Show the icon representing the *current* state, or the *action*?
        // Let's stick to: Show Sun if Light mode, Moon if Dark mode.
        // Wait, standard is: If dark, show Sun (to switch to light). If light, show Moon (to switch to dark).
        // Let's follow the previous logic which seemed to check ID relative to preference.
        
        // Let's try: If isDark is true, we have 'dark' class. We want to show the graphical representation of the current theme?
        // The original code scaled the icon with id===themePreference to 1. 
        // So if theme is 'dark', #dark (Moon) is shown.
        lightIcon.style.scale = isDark ? "0" : "1"
        darkIcon.style.scale = isDark ? "1" : "0"
    }
  }

  const getThemePreference = () => {
    if (typeof localStorage !== "undefined") {
      return localStorage.getItem("theme") ?? "light"
    }
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"
  }

  // Initial Setup
  const theme = getThemePreference()
  const isDark = theme === "dark"
  document.documentElement.classList[isDark ? "add" : "remove"]("dark")
  updateThemeUI(isDark)

  const toggleBtn = document.getElementById("theme-toggle-btn")
  
  // Remove duplicate listeners if any by creating a fresh controller logic or just simple listener
  // Since this script is inline, it runs on page load.
  if (toggleBtn) {
    toggleBtn.addEventListener("click", handleToggleClick)
  }

  document.addEventListener('astro:after-swap', () => {
    const theme = getThemePreference()
    const isDark = theme === "dark"
    document.documentElement.classList[isDark ? "add" : "remove"]("dark")
    updateThemeUI(isDark)
    
    // Re-attach listener after navigation
    const newToggleBtn = document.getElementById("theme-toggle-btn")
    if (newToggleBtn) newToggleBtn.addEventListener("click", handleToggleClick)
  })
</script>
